<!DOCTYPE html>
<html>
<head>
	<title>PV GazeVisualizer</title>
	<link rel="stylesheet" type="text/css" href="./styles/main.css">
	<style type="text/css">
	input{
		position: absolute;
	}
	</style>
</head>

<body>
<canvas id="imgCanvas" width="720" height="450" style="display: none;"></canvas>	
<canvas id="overlay" width="720" height="450" style="display: none;"></canvas>	
<input type="file" id="files" name="files[]" />
<button id="replayButton" onclick="visReset();" style="display: none;">Replay</button>
<p id="error" style="display: none;"></p>


<script src="./js/jquery-1.11.0.min.js"></script>
<script src="./config/parameter.js"></script>
<script>
// center an element and display, [w,h]: size of the window
var displayElm2Center = function(id, w, h){
    var l = (w - $(id).width())/2;
    var t = (h - $(id).height())/2;
    $(id).css({left: l, top: t});
    $(id).show();
}
function setupcanvas(){
	displayElm2Center('#files', $(window).width()-$('#imgCanvas').width()/2, ($(window).height()-$('#imgCanvas').height())/2);

	imgCanvas = document.getElementById('imgCanvas');
	imgCanvasCtx = imgCanvas.getContext('2d');	
	displayElm2Center('#imgCanvas', $(window).width(), $(window).height());
	$('#imgCanvas').show();

	overlay = document.getElementById('overlay');
	overlayCtx = overlay.getContext('2d');
	displayElm2Center('#overlay', $(window).width(), $(window).height());
	$('#overlay').show();

	smlW = 720, smlH = smlW/screen.width*screen.height, smlx = 0, smly = 0; // small window
	overlayCtx.fillStyle = pointBckColor;
	overlayCtx.fillRect(smlx,smly,smlW,smlH);
}
setupcanvas();


// read data from local file -> expsequence: experiment configuration
/*
$.getJSON( "./data/test2.js", function(json) {
  showdata(json);
 });
*/


// load local json file
var JsonObj = null;
function handleFileSelect(evt) {
    var files = evt.target.files; // FileList object
    f = files[0];
    var reader = new FileReader();

    // Closure to capture the file information.
    reader.onload = (function (theFile) {
        return function (e) {
            // Render thumbnail.
            JsonObj = e.target.result
             var parsedJSON = JSON.parse(JsonObj);
            showdata(parsedJSON);
        };
    })(f);
    reader.readAsText(f, 'UTF-8');
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);


// visualization
var expsequence, resultQueue, framenum, lastShowFrameTime, errors;
function showdata(data){
	var saveQueue = data;
	expsequence = saveQueue[1];
	resultQueue = saveQueue[2];
	errors = saveQueue[3];

	$('#replayButton').show();
	displayElm2Center('#replayButton', $(window).width()+$('#imgCanvas').width()/2, ($(window).height()-$('#imgCanvas').height())/2);
	
	$('#error').html('Training error: ' + errors.trainerr +', Testing error: ' + errors.testerr +'</br> blue circle: training, green circle: testing');
	displayElm2Center('#error', $(window).width(), ($(window).height()+$('#imgCanvas').height()));
	$('#error').show();
	visReset();
}

function visReset(){
	framenum = -1;
	lastShowFrameTime;
	visualize();
}
function visualize(){
	visualRequest = requestAnimationFrame(visualize);
	var time = new Date().getTime();
	if (lastShowFrameTime == null) lastShowFrameTime = time;
    if(time - lastShowFrameTime <= 40) return; // control frame rate: ~30 ms per frame
    lastShowFrameTime = time;

    framenum++;
    if(framenum >= resultQueue.length) return;
    var entry = expsequence[resultQueue[framenum].index];

    // draw display content
	switch(entry.type){
		case "point":
			overlayCtx.fillStyle = pointBckColor;
			overlayCtx.fillRect(smlx,smly,smlW,smlH);
			var px = entry.location[0]*smlW+smlx, py = entry.location[1]*smlH+smly, pr = smlPntRadius;
			drawCircle(overlayCtx, px, py, pr, pointColor, true);
    		break;
		case "image":
			overlayCtx.clearRect(smlx,smly,smlW,smlH);
			if(cursmlImgSrc!= null && cursmlImgSrc==entry.path){
				var s = Math.min(smlW/image.width, smlH/image.height);
				var w = image.width*s, h = image.height*s;
                imgCanvasCtx.drawImage(image, smlx+(smlW-w)/2, smly+(smlH-h)/2, w, h);
			}else{
				// cancelRequestAnimFrame(visualRequest);
				cancelAnimationFrame(visualRequest);
				image = new Image();	
                image.onload = function() {
                	imgCanvasCtx.fillStyle = "#000";
					imgCanvasCtx.fillRect(smlx,smly,smlW,smlH);
                	cursmlImgSrc = image.src;
                    var s = Math.min(smlW/image.width, smlH/image.height);
					var w = image.width*s, h = image.height*s;
                    imgCanvasCtx.drawImage(image, smlx+(smlW-w)/2, smly+(smlH-h)/2, w, h);
                    visualRequest = requestAnimationFrame(visualize);
                }
                image.src = entry.path;
			}
    		break;
		case "cross":
			var px = 0.5*smlW+smlx, py = 0.5*smlH+smly, pr = smlCrxRadius;
			overlayCtx.fillStyle = crossBckColor;
			overlayCtx.fillRect(smlx,smly,smlW,smlH);
			// draw a cross
			drawCross(overlayCtx, px, py, pr, crossColor, smlCrxLineWidth);
    		break
	}
	var predict_val = resultQueue[framenum].value;
	// show prediction results
	if (predict_val != null){
		var px = predict_val[0]*smlW+smlx, py = predict_val[1]*smlH+smly, pr = smlPntRadius;
		overlayCtx.lineWidth = smlCrxLineWidth;
		if (entry.tag == 'train'){
			drawCircle(overlayCtx, px, py, pr, predPntColor, false);	
		}else{
			drawCircle(overlayCtx, px, py, pr, predPntColorTest, false);		
		}
	}
}

// draw a circle
function drawCircle(context, x, y, r, color, fill){
	context.beginPath();
	context.arc(x, y, r, 0, 2 * Math.PI, true);
	context.closePath();
	if(fill){
		context.fillStyle = color;
		context.fill();	
	}else{
		context.strokeStyle = color;
		context.stroke();		
	}
}
// draw a cross
function drawCross(context, x, y, r, color, width){
	context.beginPath();
	context.lineWidth = width;
	context.moveTo(x-r,y);context.lineTo(x+r,y);
	context.moveTo(x,y-r);context.lineTo(x,y+r);
	context.strokeStyle = color;
	context.stroke();
	context.closePath();
}
</script>

</body>
</html>