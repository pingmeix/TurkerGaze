<!DOCTYPE html>
<html>
<body>
<canvas id="imgCanvas" width="1200" height="750"></canvas>
<p id="hitleft"></p>
<form>
Backgroud Color:
<input id="inputbckcolor" type="text" value="#585858">
</br>
Number of Pig:	
<input id="numpig" type="text" value="3">
Time Limit:
<input id="timelimit" type="text" value="10000">
#HIT:
<input id="numpighit" type="text" value="2">
</br>
Pig Size:
<input id="inputpigsize" type="text" value="120">
</form>
<button id='drawBttn' onclick="draw()" style="display: none;">draw</button>


<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript">
// pig images
var pigs = ["../icons/ab/pig1.png", "../icons/ab/pig2.png", "../icons/ab/pig3.png", "../icons/ab/pig4.png", "../icons/ab/pig5.png", "../icons/ab/pig6.png"];

var cvs, ctx;
var sW, sH;
var pigsize;
var step = 30;
var circleLineWidth = 5;
var numpighit, numpig, timelimit;
var hitcountdown, existpig = false;
var curpigpos, pigsize, cntpig;
</script>

<script type="text/javascript">
// preload icons
$.preloadImages = function() {
  for (var i = 0; i < arguments.length; i++) {
    $("<img />").attr("src", arguments[0][i]);
  }
  // enable drawing calibration points
  setup();
}
$.preloadImages(pigs);

function setup(){
	cvs = document.getElementById('imgCanvas');
	cvs.addEventListener("mousedown", getPosition, false); // mouse click event
	ctx = imgCanvas.getContext('2d');

	$('#drawBttn').css({left:1000, top:50});	
	sW = cvs.width, sH = cvs.height;

	bckcolor = $('#inputbckcolor').val();
	ctx.fillStyle = bckcolor;
	ctx.fillRect(0,0,cvs.width,cvs.height);
	$('#drawBttn').show();
}

function draw(){
	numpig = eval($('#numpig').val());
	numpighit = eval($("#numpighit").val());
	existpig = true;
	cntpig = numpig;
	if (cntpig > 0){
		drawPig();	
	}
	setTimeout(function(){
		if(existpig){
			alert("Time Out!");	
		}
	}, eval($("#timelimit").val())); // counting down
}
function drawPig(){
	ctx.fillStyle = bckcolor;
	ctx.fillRect(0,0,sW,sH);
	var image = new Image();
		image.onload = function() {
			var color_door = eval('[' + $("#inputcolordoor").val() + ']');
			pigsize = eval($("#inputpigsize").val());
			var start_r = pigsize * 0.75, end_r = 0;
			bckcolor = $('#inputbckcolor').val();
			var loc = [Math.random()*0.7+0.15, Math.random()*0.7+0.15]; // random position
			curpigpos = [sW*loc[0], sH*loc[1]];
			// draw icon
			ctx.drawImage(image, curpigpos[0]-pigsize/2, curpigpos[1]-pigsize/2, pigsize, pigsize);
			// draw blood bar
			// ctx.rect(curpigpos[0]-pigsize/2,curpigpos[1]-pigsize/2-15,pigsize,10);
			var x = curpigpos[0]-pigsize/2, y = curpigpos[1]-pigsize/2-15;
			var colorgrad=ctx.createLinearGradient(x, y, x+pigsize, y);
			colorgrad.addColorStop(0,"red");
			colorgrad.addColorStop(0.5,"yellow");
			colorgrad.addColorStop(1,"green");
			ctx.fillStyle=colorgrad;
			ctx.fillRect(x, y, pigsize,10);
			ctx.strokeStyle="black";
			ctx.beginPath();
			ctx.rect(x, y, pigsize, 10);
			ctx.stroke();

			// hit counting down
			hitcountdown = eval($("#numpighit").val());
			$('#hitleft').html(hitcountdown + ' HIT to go. ' + cntpig + ' PIG left.');
		}
	image.src = pigs[Math.floor(Math.random()*pigs.length)]; // randomly select a pig
}



function getPosition(event){
	var x = event.x;
	var y = event.y;

	var canvas = document.getElementById("imgCanvas");
	x -= canvas.offsetLeft;
	y -= canvas.offsetTop;
	if(existpig){
		// var d = Math.sqrt(Math.pow((x-curpigpos[0]*sW),2) + Math.pow((y-curpigpos[1]*sH),2));
		var d = Math.max(Math.abs(x-curpigpos[0]), Math.abs(y-curpigpos[1]));
		if (d < eval(pigsize)*0.5){
			// draw the door
			/*
			stepsize = pigsize*0.5/numpighit;
			linew = stepsize*2;
			ctx.lineWidth = linew;
			drawCircle(ctx, curpigpos[0], curpigpos[1], stepsize*(hitcountdown), bckcolor, false);
			*/
			// adjust the blood level
			hitcountdown--;

			var x = curpigpos[0]-pigsize/2, y = curpigpos[1]-pigsize/2-15;
			ctx.fillStyle = bckcolor;
			var w = hitcountdown/numpighit * pigsize;
			ctx.beginPath();
			ctx.fillRect(x+w, y, pigsize-w, 10);
			ctx.rect(x, y, pigsize, 10);
			ctx.strokeStyle = "black";
			ctx.stroke();

			
			str = [];
			if(hitcountdown <= 0){
				str += 'You killed this pig!';
				cntpig--;
				if(cntpig > 0){
					setTimeout(function(){drawPig();}, 500);
				}else{
					existpig = false;
					str = 'No pig left!';
				}
			}else{
				str += hitcountdown + ' HIT to go. ' + cntpig + ' PIG left.';
			}
			$('#hitleft').html(str);
		}else{
			$('#hitleft').html('MISS! ' + hitcountdown + ' HIT to go. ' + cntpig + ' PIG left.');
		}
	}
}

// draw closing ring animation
function drawDynamicRing(cvs, ctx, x, y, bckcolor, color, endcolor, duration, start_r, end_r, step, callback){
	var num = Math.round(duration/step);
	var r_set = new Array(num);
	var c_set = new Array(num);
	for( var i = 0; i < num; i++){
		r_set[i] = start_r+ (end_r-start_r)/num*i; // set of radius
		colormid = new Array(3);
		for (var j = 0; j < 3; j++){
			colormid[j] = color[j] + (endcolor[j]-color[j])/num*i;
		}
		colormid = colormid.map(Math.round);
		c_set[i] = 'rgb(' + colormid[0] +',' + colormid[1] + ',' + colormid[2] + ')';
	}
	drawRingLoop(cvs, ctx, x, y, r_set, c_set, bckcolor, step, 0, callback);
}

function drawRingLoop(cvs, ctx, x, y, r_set, c_set, bckcolor, step, idx, callback){
	if(idx >= r_set.length) {
		if(callback) callback();
		return;
	}
	drawCircle(ctx, x, y, r_set[idx], c_set[idx], false);
	setTimeout(function(){
		drawRingLoop(cvs, ctx, x, y, r_set, c_set, bckcolor, step, idx+1, callback);
	}, step);
}

// draw dynamic circle animation
function drawDynamicCirc(cvs, ctx, x, y, bckcolor, color, endcolor, duration, start_r, end_r, step, callback){
	var num = Math.round(duration/step);
	var r_set = new Array(num);
	var c_set = new Array(num);
	for( var i = 0; i < num; i++){
		r_set[i] = start_r+ (end_r-start_r)/num*i; // set of radius
		colormid = new Array(3);
		for (var j = 0; j < 3; j++){
			colormid[j] = color[j] + (endcolor[j]-color[j])/num*i;
		}
		colormid = colormid.map(Math.round);
		c_set[i] = 'rgb(' + colormid[0] +',' + colormid[1] + ',' + colormid[2] + ')';
	}
	drawCircleLoop(cvs, ctx, x, y, r_set, c_set, bckcolor, step, 0, callback);
}

function drawCircleLoop(cvs, ctx, x, y, r_set, c_set, bckcolor, step, idx, callback){
	if(idx >= r_set.length) {
		if(callback) callback();
		return;
	}
	ctx.fillStyle = bckcolor;
	ctx.fillRect(0,0,cvs.width,cvs.height);
	drawCircle(ctx, x, y, r_set[idx], c_set[idx], true);
	setTimeout(function(){
		drawCircleLoop(cvs, ctx, x, y, r_set, c_set, bckcolor, step, idx+1, callback);
	}, step);
}

// draw a circle, filled or stroke
function drawCircle(context, x, y, r, color, fill){
	context.beginPath();
	context.arc(x, y, r, 0, 2 * Math.PI, true);
	context.closePath();
	if(fill){
		context.fillStyle = color;
		context.fill();	
	}else{
		context.strokeStyle = color;
		context.stroke();
	}
}
</script>



</body>
</html>