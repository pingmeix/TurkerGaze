<!DOCTYPE html>
<html>
<body>
<style type="text/css">
#imgCanvas, #overlay, #score, #mark{
	position: absolute;
}
@font-face {
    font-family: subway;
    src: url(../styles/subway.ttf);
}

@font-face {
    font-family: digital;
    src: url(../styles/digital.ttf);
}

@font-face {
    font-family: zorque;
    src: url(../styles/zorque.ttf);
}

#mark{
	opacity:0.8;
	font-family: zorque;
	font-size: 100px;
	color: #3399FF;
}
</style>

<canvas id="imgCanvas" width="1000" height="600" ></canvas>
<canvas id="overlay" width="1000" height="600"></canvas>	

<form>
Number of Grids: 
</br>
[row]
<input id="gridy" type="text" value="3">
[col]
<input id="gridx" type="text" value="5">
</br>
Grid Size:
[row]
<input id="gridw" type="text" value="100">
[col]
<input id="gridh" type="text" value="100">
</br>
Spacing:
<input id="spacing" type="text" value="10">
<p id="results"></p>
<p id="score"></p>
<p id="mark"></p>
</form>
<button id='drawBttn' onclick="draw()" style="display: none;">draw</button>
<button id='submitMemTest' onclick="submitMemTest()" style="display: none;">submit</button>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript">
var icons = ["../icons/ab/ab1.png", "../icons/ab/ab2.png", "../icons/ab/ab3.png", "../icons/ab/ab4.png", "../icons/ab/ab5.png", "../icons/ab/ab6.png", "../icons/ab/ab7.png", "../icons/ab/ab8.png", "../icons/ab/ab9.png"];

var cageimg = new Image();
cageimg.src = '../icons/ab/cage.png';
var pigimg = new Image();
pigimg.src = '../icons/ab/pig1.png';

var iconset = new Array(icons.length);
function preloadIcons(idx){
	if(idx >= icons.length){
		// alert('Image preloaded!')
		$('#results').html('Image preloaded!');
		setupcanvas();
		return;
	}
	iconset[idx] = new Image();
	iconset[idx].onload = function(){
		preloadIcons(idx+1);
	};
	iconset[idx].src = icons[idx];
}
// global parameters
var imgCanvas, imgCanvasCtx, overlay, overlayCtx;

// center an element and display, [w,h]: size of the window
var displayElm2Center = function(id, w, h){
    var l = (w - $(id).width())/2;
    var t = (h - $(id).height())/2;
    $(id).css({left: l, top: t});
    $(id).show();
}

function setupcanvas(){
	imgCanvas = document.getElementById('imgCanvas');
	imgCanvasCtx = imgCanvas.getContext('2d');
	displayElm2Center('#imgCanvas', $('#imgCanvas').width(), $('#imgCanvas').height()+400);
	$('#imgCanvas').show();

	overlay = document.getElementById('overlay');
	overlayCtx = overlay.getContext('2d');
	displayElm2Center('#overlay', $('#overlay').width(),  $('#overlay').height()+400);
	$('#overlay').show();

	$('#mark').hide();

	displayElm2Center('#score', 1000, 0);
	$('#score').show();
	$('#score').css({"font-family":"digital", "color": "#F00", "font-size": "100px"});
	$('#score').html('');

	displayElm2Center('#form', $('#form').width()+40, 100);
	displayElm2Center('#drawBttn', $('#drawBttn').width()+40, 160);
	displayElm2Center('#submitMemTest', $('#submitMemTest').width()+40, 200);
	$('#submitMemTest').prop('disabled', true);

	overlay.addEventListener("mousedown", getPosition, false); // mouse click event
}

function getgridloc(x, y, size, grids, spacing){
	var numy = grids[0];
	var numx = grids[1];
	var w = size[1], h = size[0];
	var loc = new Array(numy); // one row
	for(var i = 0; i < numy; i++){
		loc[i] = new Array(numx);
		for(var j = 0; j < numx; j++){
			loc[i][j] = new Array(2);
			loc[i][j][0] = x + (j+1)*spacing + j*w;
			loc[i][j][1] = y + (i+1)*spacing + i*h;
		}
	}
	return loc;
}

function drawRoundCornerRect(ctx, x, y, w, h, color, width){
	// Set faux rounded corners
	ctx.lineJoin = 'round';
	ctx.lineWidth = width;
	ctx.strokeStyle = color;
	rcorner = width;
	ctx.strokeRect(x, y, w+(rcorner/2), h+(rcorner/2));
	ctx.stroke();
	ctx.lineJoin = 'miter';
}

function drawGridsImg(ctx, loc, size,imggrid){
	var numy = loc.length;
	var numx = loc[0].length;
	var w = size[1], h = size[0];

	for(var i = 0; i < numy; i++){
		for(var j = 0; j < numx; j++){
			// iconidx = Math.floor(Math.random()*icons.length);
			// image = iconset[iconidx];
			var image = hitimgs[gridimgs[i][j]];
			var s = Math.min(w/image.width, h/image.height);
		    var rsw = image.width*s, rsh = image.height*s;
		    ctx.drawImage(image, loc[i][j][0]+(w-rsw)/2, loc[i][j][1]+(h-rsh)/2, rsw, rsh);
		}
	}
}

function drawCage(ctx, loc, i, j, checked, answer, size){
	var image;
	if(checked == 1 && answer == 1){
		image = pigimg;
	}else if(checked == 1 && answer == 0){
		image = cageimg;
	}else if(checked == 0){
		image = hitimgs[gridimgs[i][j]];
	}
	var w = size[1], h = size[0];
	var s = Math.min(w/image.width, h/image.height);
    var rsw = image.width*s, rsh = image.height*s;
    ctx.clearRect(loc[i][j][0], loc[i][j][1], w, h);
    ctx.drawImage(image, loc[i][j][0]+(w-rsw)/2, loc[i][j][1]+(h-rsh)/2, rsw, rsh);
    if(checked == 1 && answer == 1){
		image = cageimg;
		var s = Math.min(w/image.width, h/image.height);
	    var rsw = image.width*s, rsh = image.height*s;
		ctx.drawImage(image, loc[i][j][0]+(w-rsw)/2, loc[i][j][1]+(h-rsh)/2, rsw, rsh);
	}
}

function getPosition(event){
	if(MEMTESTON == false) return;
	var cx = event.x;
	var cy = event.y;

	var canvas = document.getElementById("overlay");
	cx -= canvas.offsetLeft;
	cy -= canvas.offsetTop;

	// select picked image
	var idx = null;
	for(var i = 0; i < numgrids[0]; i++){
		for(var j = 0; j < numgrids[1]; j++){
			var x = gridloc[i][j][0];
			var y = gridloc[i][j][1];
			var w = gridsize[1], h = gridsize[0];
			if(cx >= x && cx <= x+w && cy >= y && cy <= y+h){
				idx = [i,j];
			}
		}
	}
	if(idx != null){
		gridsel[idx[0]][idx[1]] = 1 - gridsel[idx[0]][idx[1]]; // flip status
		// update grids
		overlayCtx.clearRect(0, 0, $('#overlay').width(), $('#overlay').height()); 
		drawGrids(overlayCtx, x, y, gridloc, gridsize, gridsel, gridselans, gridColor, selgridColor, gridLineWidth, selLineWidth);

		// update game score
		var mark;
		var color;
		var t = new Date().getTime();
		if(gridsel[idx[0]][idx[1]] == 1 && gridselans[idx[0]][idx[1]] == 1){
			mark = basemark - stepmark * Math.floor((t - memtestStartTime)/1000);
			gridmark[idx[0]][idx[1]] = mark;
			color = "#94FA3A";
		}
		if(gridsel[idx[0]][idx[1]] == 0 && gridselans[idx[0]][idx[1]] == 1){
			mark = -gridmark[idx[0]][idx[1]];
			gridmark[idx[0]][idx[1]] = 0;
			color = "#F77207";
		}
		if(gridsel[idx[0]][idx[1]] == 0 && gridselans[idx[0]][idx[1]] == 0){
			mark = penaltymark;
			gridmark[idx[0]][idx[1]] += penaltymark;
			color = "#18B8C9";
		}
		if(gridsel[idx[0]][idx[1]] == 1 && gridselans[idx[0]][idx[1]] == 0){
			mark = -penaltymark - stepmark * Math.floor((t - memtestStartTime)/1000);
			gridmark[idx[0]][idx[1]] = mark;
			color = "#F52600";
		}

		drawCage(imgCanvasCtx, gridloc, idx[0], idx[1], gridsel[idx[0]][idx[1]], gridselans[idx[0]][idx[1]], gridsize);
		
		var str = mark.toString();
		if(mark > 0) str = '+' + str;	
		$('#mark').css('color', color);
		$('#mark').html(str);
		displayElm2Center('#mark', Math.max(500, $('#mark').width()),  200);

		var s = 0;
		for(var i = 0; i < numgrids[0]; i++){
			for(var j = 0; j < numgrids[1]; j++){
				s += gridmark[i][j];
			}
		}
		$('#score').html(s);
		$('#score').show();
		$('#results').html(gridmark);
		$('#results').show();

		setTimeout(function(){
			$('#mark').hide();
		}, 300);
	}
}



function drawGrids(ctx, x, y, loc, size, sel, selans, color, selcolor, width, selwidth){
	var numy = loc.length;
	var numx = loc[0].length;
	var w = size[1], h = size[0];
	// draw grids
	for(var i = 0; i < numy; i++){
		for(var j = 0; j < numx; j++){
			if(sel[i][j] == 0){
				drawRoundCornerRect(ctx, loc[i][j][0], loc[i][j][1], w, h, color, width);			
			}
			else if(selans[i][j] == 1){
				drawRoundCornerRect(ctx, loc[i][j][0], loc[i][j][1], w, h, selcolor[0], selwidth);
			}
			else{
				drawRoundCornerRect(ctx, loc[i][j][0], loc[i][j][1], w, h, selcolor[1], selwidth);
			}
		}
	}
}

preloadIcons(0);

var numgrids;
var gridsize; // w, h, spacing
var gridloc; // location of each image grid
var gridmark; // marks for each bird
var gridsel = null; // 0: unchecked, 1: checked
var gridimgs = null; // image path
var gridColor = "#333333";
var selgridColor = ["#0F0", "#F00"];
var gridLineWidth = 2;
var selLineWidth = 5;
var gridselans = null;
var memtestStartTime = null;
var memetesTimeLimit = 20000;
var basemark = 500;
var stepmark = 10;
var penaltymark = Math.floor(memetesTimeLimit/1000*stepmark);
var MEMTESTON = false;
var x = 50, y = 50;
var numshown = 3;
var numimg = 8;
var memimglist =  null;
var hitimgs;
// var memshowidx, memdispidx;


function draw(){
	imgCanvasCtx.clearRect(0, 0, $('#imgCanvas').width(), $('#imgCanvas').width()); 
	overlayCtx.clearRect(0, 0, $('#overlay').width(), $('#overlay').height()); 

	numgrids = [eval($("#gridy").val()), eval($("#gridx").val())];
	gridsize = [eval($("#gridw").val()), eval($("#gridh").val())];
	spacing = eval($("#spacing").val());

	hitimgs = new Array(numimg+numgrids[0]*numgrids[1]-numshown);
	for(var i = 0; i < hitimgs.length; i++){
		if(i < numimg){
			hitimgs[i] = iconset[0];
		}else{
			iconidx = Math.floor(Math.random()*(icons.length-1));
			hitimgs[i] = iconset[iconidx+1];	
		}
	}

	var memshowidx = nchoosekRandom(numimg, numshown);
	for(var i = numimg; i < hitimgs.length; i++){
		memshowidx.push(i);
	}
	var memdispidx = nchoosekRandom(numgrids[0]*numgrids[1], numgrids[0]*numgrids[1]);
	var cnt = 0;
	gridsel = new Array(numgrids[0]); // check status
	gridmark = new Array(numgrids[0]); // mark
	gridimgs = new Array(numgrids[0]); // image path
	for(var i = 0; i < numgrids[0]; i++){
		gridsel[i] = new Array(numgrids[1]);
		gridmark[i] = new Array(numgrids[1]);
		gridimgs[i] = new Array(numgrids[1]);
		for(var j = 0; j < numgrids[1]; j++){
			gridsel[i][j] = 0;
			gridmark[i][j] = 0;
			gridimgs[i][j] = memshowidx[memdispidx[cnt++]];
		}
	}

	// ground truth grid
	gridselans = new Array(numgrids[0]);
	for(var i = 0; i < numgrids[0]; i++){
		gridselans[i] = new Array(numgrids[1]);
		for(var j = 0; j < numgrids[1]; j++){
			gridselans[i][j] = 0;
			for(var k = 0; k < numshown; k++){
				if(gridimgs[i][j] == memshowidx[k]){
					gridselans[i][j] = 1;
					break;
				}
			}
		}
	}

	// ground truth
	gridloc = getgridloc(0, 0, [10,10], numgrids, 5);
	drawGrids(imgCanvasCtx, x, y, gridloc, [5,5], gridselans, gridselans, gridColor, selgridColor, 5, 5);

	gridloc = getgridloc(x, y, gridsize, numgrids, spacing);
	drawGrids(overlayCtx, x, y, gridloc, gridsize, gridsel, gridselans, gridColor, selgridColor, gridLineWidth, selLineWidth);
	drawGridsImg(imgCanvasCtx, gridloc, gridsize, memimglist);
	memtestStartTime = new Date().getTime();
	MEMTESTON = true;

	$('#score').show();
	$('#results').html(gridmark);
	$('#results').show();
	$('#submitMemTest').prop('disabled', false);
	setTimeout(function(){
		if(MEMTESTON == false) return; // already submitted
		alert('Time Out!');
		MEMTESTON = false;
	}, memetesTimeLimit);
}

function nchoosekRandom(n, k){
	var idx = new Array(n);
	var ind = new Array(n);
	for(var i = 0; i < n; i++){
		idx[i] = i;
		ind[i] = false
	} 
	var loc = new Array(k);
	for(var i = 0; i < k; i++){
		var r = Math.floor(Math.random()*(n-i));
		var cnt = -1;
		for(var j = 0; j < n; j++){
			if(ind[j] == false){
				cnt++;
				if(cnt == r){
					ind[j] = true;
					loc[i] = j;
					break;
				}
			}
		}
	}
	return loc;
}

function permutator (input) {
	var set =[];
	function permute (arr, data) {
		var cur, memo = data || [];
		for (var i = 0; i < arr.length; i++) {
			cur = arr.splice(i, 1)[0];
			if (arr.length === 0) set.push(memo.concat([cur]));
			permute(arr.slice(), memo.concat([cur]));
			arr.splice(i, 0, cur);
		}
		return set;
	}
	return permute(input);
}


function submitMemTest(){
	MEMTESTON = false;

	var t = new Date().getTime();
	var mark = 0;
	var cnt = 0; // number of correct selection
	var s = 0; // total score
	for(var i = 0; i < numgrids[0]; i++){
		for(var j = 0; j < numgrids[1]; j++){
			s += gridmark[i][j];
			if(gridsel[i][j] == 1 && gridselans[i][j] == 1) cnt++;
		}
	}
	if(memetesTimeLimit - (t-memtestStartTime) > 0 && cnt > 0){
		mark = stepmark * Math.floor((memetesTimeLimit - (t-memtestStartTime)) / 1000) * cnt;
	}
	s += mark;
	
	var str = mark.toString();
	if(mark > 0) str = '+' + str;	
	str = 'BONUS: ' + str;
	var color = "#8925D0";
	$('#mark').css('color', color);
	$('#mark').html(str);
	displayElm2Center('#mark', Math.max(500, $('#mark').width()),  200);
	setTimeout(function(){
		$('#mark').hide();
	}, 800);
	
	$('#score').html(s);
	$('#score').show();
	$('#submitMemTest').prop('disabled', true);
}

</script>



</body>
</html>
